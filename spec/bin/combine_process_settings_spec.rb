# frozen_string_literal: true

require 'spec_helper'
require 'process_settings/hash_path'

describe 'combine_process_settings' do
  it "should print usage and exit 1 if no arguments given" do
    output = `bin/combine_process_settings.rb 2>&1`

    expect(output).to eq(<<~EOS)
      usage: combine_process_settings.rb -r staging|production -o combined_process_settings.yml
          -v, --verbose                    Verbose mode.
          -r, --root_folder=ROOT
          -o, --output=FILENAME            Output file.
    EOS
    expect($?.exitstatus).to eq(1)
  end

  it "should combine all settings files alphabetically, with a magic comment at the top and END: true at the end" do
    output = `bin/combine_process_settings.rb -r spec/fixtures/production -o combined_process_settings.yml && cat spec/fixtures/production/combined_process_settings.yml && rm -f spec/fixtures/production/combined_process_settings.yml`

    expect(output).to eq(<<~EOS)
      ---
      #
      # Don't edit this file directly! It was generated by combine_process_settings.rb from the files in production/settings/.
      #
      - filename: honeypot.yml
        settings:
          honeypot:
            max_recording_seconds: 600
            answer_odds: 100
            status_change_min_days: 10
      - filename: tech-1234_call_counts_drift_investigation.yml
        target:
          app: ccn
        settings:
          call_counts:
            complete_sync_seconds: 60
      - filename: flag_drop.yml
        target:
          region: east
        settings:
          reject_incoming_calls: 0
      - filename: debug_sip_private_caller_id.yml
        target:
          app: ringswitch
          region: west
        settings:
          log_stream:
            sip: caller_id_privacy
      - END: true
    EOS

    expect($?.exitstatus).to eq(0)
  end
end
