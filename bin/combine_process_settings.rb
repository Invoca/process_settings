#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pathname'
require 'fileutils'
require 'yaml'

PROGRAM_NAME = File.basename($PROGRAM_NAME)
SETTINGS_FOLDER = 'settings'
END_MARKER = { 'END' => true }.freeze

def check_options(argv)
  unless argv.size == 1
    warn "usage: #{PROGRAM_NAME} <root_folder> > combined_process_settings.yml"
    exit(1)
  end

  argv.first
end

def read_and_combine_settings
  combined_settings = []

  Dir.glob("**/*.yml") do |settings_path|
    settings = { 'filename' => settings_path }
    settings.merge!(YAML.load_file(settings_path))

    combined_settings << settings
  end

  combined_settings
end

def add_warning_comment(yaml, folder, program_name, settings_folder)
  warning_comment = <<~EOS
  #
  # Don't edit this file directly! It was generated by #{program_name} from the files in #{folder.split('/').last}/#{settings_folder}/.
  #
  EOS

  yaml.sub("\n", "\n" + warning_comment)
end

#
# main
#
folder = check_options(ARGV.freeze)

FileUtils.cd(Pathname.new(folder) + SETTINGS_FOLDER)

combined_settings = read_and_combine_settings
combined_settings << END_MARKER

yaml = combined_settings.to_yaml

yaml_with_warning_comment = add_warning_comment(yaml, folder, PROGRAM_NAME, SETTINGS_FOLDER)

puts yaml_with_warning_comment
